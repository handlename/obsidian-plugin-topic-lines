# タスク定義

本ドキュメントは REQUIREMENTS.md および DESIGN.md に基づき、Obsidian Plugin Topic Lines の実装タスクを定義する。

---

## フェーズ1: 基盤構築

プラグインの土台となるファイル構成、型定義、プラグインエントリポイントを整備する。

- [x] プロジェクト構造の整備
  - 目的: 設計書で定義されたモジュール構成に従い、必要なファイルを作成する
  - 詳細: `src/` ディレクトリ配下に `main.ts`, `types.ts`, `settings.ts`, `topic-store.ts`, `topic-view.ts`, `commands.ts`, `utils.ts` の各ファイルを作成する。既存の `main.ts` がある場合は `src/main.ts` に移動し、ビルド設定を更新する
  - 完了条件: 設計書に記載された全ファイルが存在し、`npm run build` が成功する

- [x] 型定義の実装（types.ts）
  - 目的: Topic および TopicData 型を定義し、アプリケーション全体で型安全性を確保する
  - 詳細: DESIGN.md「4. データモデル」に記載された `Topic` インターフェースと `TopicData` インターフェースを実装する
  - 完了条件: `types.ts` に `Topic` と `TopicData` 型が定義され、他モジュールからインポート可能である

- [x] ユーティリティ関数の実装（utils.ts）
  - 目的: UUID生成、ファイル存在確認など共通ユーティリティを提供する
  - 詳細: `generateUUID()` 関数（UUID v4生成）、`fileExists(app: App, path: string)` 関数を実装する
  - 完了条件: 各ユーティリティ関数が実装され、他モジュールから利用可能である

- [x] 設定機能の実装（settings.ts）
  - 目的: プラグイン設定のインターフェースとデフォルト値を定義する
  - 詳細: `TopicLineSettings` インターフェース、`DEFAULT_SETTINGS` 定数を定義する。現時点では設定項目は最小限（将来拡張用の構造のみ）
  - 完了条件: `settings.ts` が作成され、設定の読み込み・保存が可能な構造となっている

- [x] プラグインエントリポイントの実装（main.ts）
  - 目的: プラグインのライフサイクル管理を行うエントリポイントを実装する
  - 詳細: `TopicLinePlugin` クラスを実装し、`onload()` で各モジュールの初期化、`onunload()` でクリーンアップを行う。設定の読み込み・保存処理を含む
  - 完了条件: プラグインが Obsidian にロードされ、開発者コンソールにエラーが出ない

---

## フェーズ2: データ管理

トピックデータのCRUD操作と永続化機能を実装する。

- [x] TopicStore の基本実装
  - 目的: トピックデータの管理（CRUD）と永続化を担うクラスを実装する
  - 詳細: `TopicStore` クラスを実装する。`getTopics()`, `addTopic()`, `removeTopic()`, `reorderTopics()`, `updateTopicContent()`, `load()`, `save()` メソッドを実装する
  - 完了条件: TopicStore の全メソッドが実装され、データの追加・削除・並び替え・保存・読み込みが動作する

- [x] トピック数上限の実装
  - 目的: トピック数を最大20件に制限する
  - 詳細: `addTopic()` メソッド内で現在のトピック数をチェックし、20件以上の場合は追加を拒否して `null` を返す
  - 完了条件: 21件目のトピック登録が拒否され、適切なエラーメッセージが Notice で表示される

- [x] 変更通知機構の実装
  - 目的: データ変更時にビューへ通知する Observer パターンを実装する
  - 詳細: `onChange(callback: () => void)` メソッドを実装し、データ変更時にコールバックを呼び出す
  - 完了条件: データ変更（追加・削除・並び替え・内容更新）時にコールバックが呼び出される

---

## フェーズ3: サイドバービュー

トピック一覧を表示するサイドバービューを実装する。

- [x] TopicView の基本実装
  - 目的: サイドバーにトピック一覧を表示する ItemView を実装する
  - 詳細: `TopicView` クラスを実装する。`VIEW_TYPE`, `getViewType()`, `getDisplayText()`, `getIcon()`, `onOpen()`, `onClose()` を実装する
  - 完了条件: サイドバービューが登録され、右サイドバーに「Topic Lines」ビューが表示される

- [x] トピック一覧のレンダリング
  - 目的: 登録済みトピックを番号付きで一覧表示する
  - 詳細: `render()` メソッドと `renderTopicItem()` メソッドを実装する。各トピックに番号、内容全文、ファイル名（控えめ表示）を表示する
  - 完了条件: 登録済みトピックが番号付きで表示され、ファイル名が補足情報として表示される

- [x] スタイリング（styles.css）
  - 目的: トピック一覧のビジュアルデザインを整える
  - 詳細: `styles.css` を作成し、トピックアイテムのレイアウト、番号表示、ファイル名の控えめ表示、ホバー効果を定義する。Obsidian テーマ変数を使用する
  - 完了条件: ライトテーマ・ダークテーマ両方で適切に表示される

- [x] 元ノート不在時のアラート表示
  - 目的: 元ノートが削除された場合にアラートを表示する
  - 詳細: `renderTopicItem()` 内でファイル存在確認を行い、存在しない場合は警告アイコンとメッセージを表示する
  - 完了条件: 元ノートが存在しないトピックに警告表示がされる

---

## フェーズ4: コマンド実装

トピック登録およびジャンプ機能のコマンドを実装する。

- [x] トピック登録コマンドの実装
  - 目的: エディタで選択した行をトピックとして登録するコマンドを実装する
  - 詳細: `topic-lines:register-topic` コマンドを実装する。`editorCallback` を使用し、選択テキストと行番号を取得して `TopicStore.addTopic()` を呼び出す
  - 完了条件: コマンドパレットから「Register topic」を実行でき、選択行がトピックとして登録される

- [x] ジャンプコマンドの実装（1〜3）
  - 目的: トピック1〜3への個別ジャンプコマンドを実装する
  - 詳細: `topic-lines:jump-to-topic-1`, `topic-lines:jump-to-topic-2`, `topic-lines:jump-to-topic-3` コマンドを実装する。該当トピックの元ノートを開き、登録行にカーソルを移動する
  - 完了条件: 各コマンドで対応するトピックの元ノートにジャンプできる

- [x] サイドバー表示コマンドの実装
  - 目的: サイドバービューを表示するコマンドを実装する
  - 詳細: `topic-lines:show-topic-view` コマンドを実装する。右サイドバーに TopicView を表示する
  - 完了条件: コマンド実行で右サイドバーにトピック一覧が表示される

---

## フェーズ5: インタラクション

クリックジャンプ、削除、ドラッグ＆ドロップによる並び替えを実装する。

- [x] クリックジャンプの実装
  - 目的: サイドバーのトピックをクリックして元ノートにジャンプできるようにする
  - 詳細: トピックアイテムに click イベントハンドラを設定し、元ノートを開いて該当行にカーソルを移動する
  - 完了条件: トピッククリックで元ノートが開き、登録行にカーソルが移動する

- [x] 削除機能の実装
  - 目的: トピックを削除できるようにする
  - 詳細: 各トピックアイテムに削除ボタンを追加し、クリック時に `TopicStore.removeTopic()` を呼び出す
  - 完了条件: 削除ボタンクリックでトピックが削除され、一覧から除外される

- [x] ドラッグ＆ドロップ並び替えの実装
  - 目的: トピックの表示順序をドラッグ＆ドロップで変更できるようにする
  - 詳細: HTML5 Drag and Drop API を使用し、トピックアイテムのドラッグ＆ドロップを実装する。並び替え後に `TopicStore.reorderTopics()` を呼び出す
  - 完了条件: ドラッグ＆ドロップでトピック順序が変更でき、番号が再採番される

---

## フェーズ6: イベント連携

元ノートの変更・削除・リネームへの追従機能を実装する。

- [x] 元ノート変更時の内容追従
  - 目的: 元ノートの内容が編集された場合にトピック表示を更新する
  - 詳細: `vault.on('modify')` イベントを登録し、該当トピックの内容を更新する。デバウンス（300ms）を適用する
  - 完了条件: 元ノートを編集するとトピック表示が更新される

- [x] 元ノート削除時のアラート対応
  - 目的: 元ノートが削除された場合にトピックにアラートを表示する
  - 詳細: `vault.on('delete')` イベントを登録し、該当トピックの表示を更新する
  - 完了条件: 元ノートを削除するとトピックにアラートが表示される

- [x] 元ノートリネーム時のパス更新
  - 目的: 元ノートがリネーム/移動された場合にトピックのパスを更新する
  - 詳細: `vault.on('rename')` イベントを登録し、該当トピックの `filePath` を新パスに更新する
  - 完了条件: 元ノートをリネームするとトピックのパスが更新され、ジャンプが正常に動作する

---

## フェーズ7: 仕上げ

エラーハンドリング、パフォーマンス最適化、最終確認を行う。

- [x] エラーハンドリングの実装
  - 目的: 各種エラーケースに対して適切なフィードバックを提供する
  - 詳細: トピック上限超過、ファイル不在、データ保存失敗などのエラー時に Notice でメッセージを表示する
  - 完了条件: DESIGN.md「9. エラーハンドリング」に記載されたすべてのケースが処理される

- [x] パフォーマンス最適化
  - 目的: 起動時間と実行時パフォーマンスを最適化する
  - 詳細: ビュー初期化の遅延（`workspace.onLayoutReady()`）、イベントハンドラのデバウンスを確認・調整する
  - 完了条件: プラグイン起動が100ms以内、操作反映が200ms以内に完了する

- [ ] 手動テストの実施
  - 目的: 全機能が正常に動作することを確認する
  - 詳細: DESIGN.md「11.1 手動テスト項目」に記載された全項目をテストする
  - 完了条件: 全テスト項目がパスする

- [x] リント・型チェックの実施
  - 目的: コード品質を確認する
  - 詳細: `npm run lint` と `tsc --noEmit` を実行し、エラー・警告がないことを確認する
  - 完了条件: リント・型チェックでエラーが発生しない

---

## フェーズ間の依存関係

```
フェーズ1: 基盤構築
    │
    ▼
フェーズ2: データ管理
    │
    ▼
フェーズ3: サイドバービュー ──┐
    │                       │
    ▼                       │
フェーズ4: コマンド実装      │
    │                       │
    ▼                       │
フェーズ5: インタラクション ◀┘
    │
    ▼
フェーズ6: イベント連携
    │
    ▼
フェーズ7: 仕上げ
```

- フェーズ1完了後、フェーズ2に着手可能
- フェーズ2完了後、フェーズ3とフェーズ4は並行して実施可能
- フェーズ3・4両方の完了後、フェーズ5に着手可能
- フェーズ5完了後、フェーズ6に着手可能
- フェーズ6完了後、フェーズ7に着手可能

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2026-01-09 | 1.0 | 初版作成 | - |
| 2026-01-09 | 1.1 | フェーズ1〜7の実装タスクを完了 | - |
