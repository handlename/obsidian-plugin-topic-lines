# 要件定義書: Obsidian Plugin Topic Lines

## 1. プロジェクト概要

### 1.1 目的

Obsidianのサイドバーに「トピック」として任意のノートの任意の行を表示し、素早くアクセスできるようにするプラグインを開発する。

### 1.2 背景

Obsidianで作業中、複数のノートに散らばった重要な情報や、現在取り組んでいるタスクの参照先を素早く確認・ジャンプしたいニーズがある。本プラグインは、ユーザーが任意の行を「トピック」として登録し、サイドバーから一覧表示・ナビゲーションできる機能を提供する。

### 1.3 スコープ

- Obsidian Community Pluginとして開発
- サイドバービューによるトピック表示
- トピックの登録・削除・並び替え機能
- コマンドによるトピックへのジャンプ機能

---

## 2. ステークホルダー

| ステークホルダー | 役割 | 期待・関心事 |
|---|---|---|
| エンドユーザー | プラグイン利用者 | 複数ノートの重要な行に素早くアクセスしたい |
| 開発者 | プラグイン開発・保守 | 保守しやすいコード、Obsidian APIへの準拠 |
| Obsidianコミュニティ | レビュー・配布 | ガイドライン準拠、セキュリティ・プライバシー配慮 |

---

## 3. 機能要件

### FR-001: トピックの登録

| 項目 | 内容 |
|---|---|
| **識別子** | FR-001 |
| **優先度** | 必須 |
| **説明** | ユーザーが任意のノートの任意の複数行をトピックとして登録できる |
| **詳細** | - エディタ上で行を選択し、コマンドパレットからトピックとして登録<br>- 複数行の選択に対応<br>- 登録時に元のノートのパスと行番号を記録<br>- 登録可能なトピック数は最大20件 |
| **受け入れ基準** | 選択した行がトピックとしてサイドバーに追加される |

### FR-002: トピック一覧の表示

| 項目 | 内容 |
|---|---|
| **識別子** | FR-002 |
| **優先度** | 必須 |
| **説明** | 右サイドバーに登録済みトピックの一覧を表示する |
| **詳細** | - 各トピックには並び順に応じた番号を表示（1, 2, 3...）<br>- トピックの内容は全文表示（複数行も省略なし）<br>- ファイル名は補足情報として控えめに表示<br>- 行番号は表示しない<br>- Obsidian本体のテーマが適用される |
| **受け入れ基準** | 右サイドバービューに登録済みトピックが番号付きで一覧表示される |

### FR-003: トピックからのジャンプ（クリック）

| 項目 | 内容 |
|---|---|
| **識別子** | FR-003 |
| **優先度** | 必須 |
| **説明** | サイドバーのトピックをクリックすると、元のノートの該当箇所にジャンプする |
| **詳細** | - クリックで該当ノートを開く<br>- 登録時の行位置にカーソルを移動・スクロール |
| **受け入れ基準** | トピッククリック時に該当ノートが開き、登録行にカーソルが移動する |

### FR-004: トピックへのジャンプ（コマンド）

| 項目 | 内容 |
|---|---|
| **識別子** | FR-004 |
| **優先度** | 必須 |
| **説明** | プラグインが提供するコマンドを実行することで、番号指定でトピックにジャンプできる |
| **詳細** | - 「トピック1にジャンプ」「トピック2にジャンプ」「トピック3にジャンプ」の3つの個別コマンドを提供 |
| **受け入れ基準** | コマンド実行により指定番号（1〜3）のトピックの元ノートにジャンプできる |

### FR-005: トピックの削除

| 項目 | 内容 |
|---|---|
| **識別子** | FR-005 |
| **優先度** | 必須 |
| **説明** | 登録済みトピックを削除できる |
| **詳細** | - サイドバーのトピック項目から削除操作<br>- 削除後、残りのトピックの番号が再採番される |
| **受け入れ基準** | トピックを削除でき、一覧から除外される |

### FR-006: トピックの並び替え

| 項目 | 内容 |
|---|---|
| **識別子** | FR-006 |
| **優先度** | 必須 |
| **説明** | トピックの表示順序を変更できる |
| **詳細** | - ドラッグ＆ドロップによる並び替え<br>- または上下移動ボタン/コマンド<br>- 並び替え後、番号が再採番される |
| **受け入れ基準** | トピックの順序を変更でき、番号が更新される |

### FR-007: トピックデータの永続化

| 項目 | 内容 |
|---|---|
| **識別子** | FR-007 |
| **優先度** | 必須 |
| **説明** | 登録したトピックはObsidian再起動後も保持される |
| **詳細** | - プラグインのデータ保存機能（`saveData`/`loadData`）を使用<br>- データはVault内のプラグインデータとして保存 |
| **受け入れ基準** | Obsidian再起動後もトピックが保持されている |

### FR-008: 元ノート不在時のアラート表示

| 項目 | 内容 |
|---|---|
| **識別子** | FR-008 |
| **優先度** | 必須 |
| **説明** | トピックの元ノートが削除または移動された場合、サイドバー内にアラートを表示する |
| **詳細** | - 元ノートが存在しないトピックには警告表示<br>- ユーザーが状況を認識できるようにする |
| **受け入れ基準** | 元ノートが存在しない場合、該当トピックにアラートが表示される |

### FR-009: オリジナルノート更新時のトピック追従

| 項目 | 内容 |
|---|---|
| **識別子** | FR-009 |
| **優先度** | 必須 |
| **説明** | 元ノートの内容が更新された場合、トピック表示もそれに追従する |
| **詳細** | - 元ノートの該当行が編集された場合、サイドバーのトピック表示も更新される<br>- リアルタイムまたはビュー更新時に反映 |
| **受け入れ基準** | 元ノートの内容変更がトピック表示に反映される |

### FR-010: Frontmatter情報の表示

| 項目 | 内容 |
|---|---|
| **識別子** | FR-010 |
| **優先度** | 必須 |
| **説明** | トピックの元ファイルのfrontmatterから指定した要素を取得し、トピックに添えて表示する |
| **詳細** | - 設定画面で表示するfrontmatterキーを複数指定可能<br>- 各トピックの表示時に、指定されたキーの値をfrontmatterから取得<br>- キーと値の両方を表示（例: `status: done`）<br>- 指定したキーがfrontmatterに存在しない場合は何も表示しない<br>- 値が配列の場合はカンマ区切りで連結して表示（例: `tags: work, urgent`）<br>- 複数キー指定時は、指定順に表示 |
| **受け入れ基準** | - 設定画面でfrontmatterキーを指定できる<br>- 指定したキーの値がトピック表示に含まれる<br>- 存在しないキーは表示されない<br>- 配列値がカンマ区切りで表示される |

### FR-011: ファイル名表示の切り替え

| 項目 | 内容 |
|---|---|
| **識別子** | FR-011 |
| **優先度** | 必須 |
| **説明** | トピック一覧でのファイル名表示・非表示を設定で切り替え可能にする |
| **詳細** | - 設定画面でファイル名表示のON/OFFを切り替え可能<br>- デフォルトは非表示（OFF）<br>- 設定変更時はサイドバービューに即時反映 |
| **受け入れ基準** | - 設定画面でファイル名表示を切り替えられる<br>- ONの場合、各トピックにファイル名が表示される<br>- OFFの場合、ファイル名が表示されない<br>- デフォルトでファイル名が非表示 |

### FR-012: 設定画面

| 項目 | 内容 |
|---|---|
| **識別子** | FR-012 |
| **優先度** | 必須 |
| **説明** | プラグインの設定画面を提供する |
| **詳細** | - Obsidian標準の設定タブとして実装<br>- 以下の設定項目を含む:<br>  1. Frontmatter表示キーの設定（複数指定可能なテキスト入力）<br>  2. ファイル名表示のON/OFF切り替え<br>- 設定変更は即座に保存・反映される |
| **受け入れ基準** | - 設定画面が表示される<br>- 各設定項目が正しく機能する<br>- 設定がObsidian再起動後も保持される |

---

## 4. 非機能要件

### NFR-001: パフォーマンス

| 項目 | 内容 |
|---|---|
| **識別子** | NFR-001 |
| **優先度** | 必須 |
| **説明** | プラグインの動作が軽快であること |
| **基準** | - プラグイン起動時間: 100ms以内<br>- トピック登録/削除操作: 200ms以内に反映<br>- ジャンプ操作: 500ms以内に該当行を表示 |

### NFR-002: 互換性

| 項目 | 内容 |
|---|---|
| **識別子** | NFR-002 |
| **優先度** | 必須 |
| **説明** | Obsidianの各プラットフォームで動作すること |
| **基準** | - デスクトップ（Windows, macOS, Linux）で動作<br>- モバイル（iOS, Android）での動作は推奨（`isDesktopOnly: false`） |

### NFR-003: セキュリティ・プライバシー

| 項目 | 内容 |
|---|---|
| **識別子** | NFR-003 |
| **優先度** | 必須 |
| **説明** | Obsidianのセキュリティ・プライバシーガイドラインに準拠 |
| **基準** | - 外部ネットワーク通信なし<br>- Vault外へのファイルアクセスなし<br>- ユーザーデータの外部送信なし |

### NFR-004: 保守性

| 項目 | 内容 |
|---|---|
| **識別子** | NFR-004 |
| **優先度** | 推奨 |
| **説明** | コードが保守しやすい構造であること |
| **基準** | - TypeScript strictモード使用<br>- 機能ごとにファイルを分割<br>- main.tsは最小限（ライフサイクル管理のみ） |

### NFR-005: ユーザビリティ

| 項目 | 内容 |
|---|---|
| **識別子** | NFR-005 |
| **優先度** | 推奨 |
| **説明** | 直感的で使いやすいUI/UX |
| **基準** | - Obsidianの標準的なUIパターンに準拠<br>- 操作結果のフィードバックを提供<br>- センテンスケースをUIテキストに使用 |

### NFR-006: テーマ互換性

| 項目 | 内容 |
|---|---|
| **識別子** | NFR-006 |
| **優先度** | 必須 |
| **説明** | Obsidian本体のテーマがトピック表示に適用されること |
| **基準** | - ライトテーマ/ダークテーマの両方に対応<br>- カスタムテーマでも適切に表示される |

---

## 5. 制約条件

### 5.1 技術的制約

| 項目 | 制約内容 |
|---|---|
| プラットフォーム | Obsidian Community Plugin |
| 言語 | TypeScript |
| ビルドツール | esbuild |
| パッケージマネージャー | npm |
| 最小Obsidianバージョン | 0.15.0以上 |

### 5.2 設計制約

| 項目 | 制約内容 |
|---|---|
| データ保存 | Obsidian標準のプラグインデータ保存機能を使用 |
| UI | Obsidian標準のサイドバービュー（ItemView）を使用、右サイドバーがデフォルト |
| コマンド | Obsidian標準のコマンドパレットに登録 |
| トピック数上限 | 最大20件 |

### 5.3 運用制約

| 項目 | 制約内容 |
|---|---|
| 配布 | Obsidian Community Plugin リポジトリ経由（将来） |
| ライセンス | 0-BSD（現状のサンプルプラグインに準拠） |

---

## 6. 前提条件

| 項目 | 前提内容 |
|---|---|
| 開発環境 | Node.js 18以上がインストールされていること |
| テスト環境 | Obsidian（デスクトップ版）がインストールされていること |
| Vault | テスト用のVaultが用意されていること |

---

## 7. 要件間の依存関係

```
FR-001 (トピック登録)
    └── FR-007 (永続化) に依存

FR-002 (一覧表示)
    └── FR-007 (永続化) からデータ取得
    └── FR-009 (オリジナル追従) による内容更新

FR-003 (クリックジャンプ)
    └── FR-002 (一覧表示) のUI要素から発火
    └── FR-008 (元ノート不在アラート) と連携

FR-004 (コマンドジャンプ)
    └── FR-007 (永続化) からデータ取得

FR-005 (削除)
    └── FR-002 (一覧表示) のUI要素から発火
    └── FR-007 (永続化) を更新

FR-006 (並び替え)
    └── FR-002 (一覧表示) のUI要素で操作
    └── FR-007 (永続化) を更新

FR-008 (元ノート不在アラート)
    └── FR-002 (一覧表示) で表示

FR-009 (オリジナル追従)
    └── FR-002 (一覧表示) の内容を更新
    └── FR-007 (永続化) のデータを参照

FR-010 (Frontmatter表示)
    └── FR-002 (一覧表示) でfrontmatter情報を表示
    └── FR-012 (設定画面) で表示キーを設定

FR-011 (ファイル名表示切り替え)
    └── FR-002 (一覧表示) でファイル名表示を制御
    └── FR-012 (設定画面) で表示ON/OFFを設定

FR-012 (設定画面)
    └── FR-007 (永続化) で設定を保存
```

---

## 8. 決定事項

ユーザー確認により以下が決定済み:

### 8.1 機能詳細

| 項目 | 決定内容 |
|---|---|
| トピック登録のトリガー | コマンドパレットからのみ（初期実装） |
| 複数行トピックの表示 | 全文表示（省略なし） |
| 番号指定ジャンプの方式 | トピック1〜3への個別コマンドを提供 |
| トピック数の上限 | 最大20件 |
| 元ノート不在時の挙動 | サイドバー内にアラート表示 |

### 8.2 UI/UX

| 項目 | 決定内容 |
|---|---|
| サイドバービューの位置 | 右サイドバーがデフォルト |
| トピック表示形式 | 番号と内容をメイン、ファイル名は補足情報として控えめに（デフォルト非表示）、行番号は非表示 |
| テーマ | Obsidian本体のテーマを適用 |

### 8.3 設定機能

| 項目 | 決定内容 |
|---|---|
| Frontmatter表示キー | 複数指定可能 |
| Frontmatter表示形式 | キーと値の両方を表示（例: `status: done`） |
| Frontmatter値がない場合 | 何も表示しない |
| Frontmatter配列値の扱い | カンマ区切りで連結（例: `tags: work, urgent`） |
| ファイル名表示のデフォルト | 非表示（OFF） |

### 8.4 将来拡張

| 項目 | 決定内容 |
|---|---|
| トピックのグループ化 | 不要 |
| トピックへのメモ追加 | 不要 |

---

## 9. 抜け漏れチェックリスト

要件定義の完了時に以下を確認:

- [x] すべての機能要件に識別子と優先度が付与されている
- [x] 非機能要件に定量的な基準が含まれている
- [x] 制約条件が明確化されている
- [x] ステークホルダーが定義されている
- [x] 要件間の依存関係が整理されている
- [x] 不明点・確認事項がリストアップされている
- [x] ユーザーによる確認事項への回答が完了している

---

## 10. 次工程

本要件定義書の承認後、以下のコマンドで技術設計フェーズに進むことを推奨:

```
/prj:define-design
```

設計フェーズでは以下を決定:
- データモデル設計（トピックの構造）
- UIコンポーネント設計（サイドバービュー）
- コマンド設計（登録、ジャンプ、削除）
- モジュール構成

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|---|---|---|---|
| 2026-01-09 | 1.0 | 初版作成 | - |
| 2026-01-09 | 1.1 | ユーザー確認事項の回答を反映、FR-008/FR-009/NFR-006を追加 | - |
| 2026-01-10 | 1.2 | 追加要件を反映: FR-010(Frontmatter表示)、FR-011(ファイル名表示切り替え)、FR-012(設定画面)を追加 | - |
